# velopipe

Pipeline for RNA Velocity using Velocyto & scVelo

## Setup

```bash
aws s3 cp s3://dp-lab-home/software/install-Velopipe-0.0.6.sh - | bash
```

## Preparing Job File

You need to provide two JSON files that describes your job:

### ${sample-name}.inputs.json

```json
{
    "Velopipe.countsMatrix": "s3://dp-lab-data/collaborators/pi/project/sample/..._dense.csv",
    "Velopipe.bam": "s3://dp-lab-data/collaborators/pi/project/sample/..._Aligned.out.sorted.bam",
    "Velopipe.bai": "s3://dp-lab-data/collaborators/pi/project/sample/..._Aligned.out.sorted.bam.bai",
    "Velopipe.gtf": "s3://seqc-public/genomes/mm38_long_polya/annotations.gtf",
    "Velopipe.barcodeWhitelist": "s3://seqc-public/barcodes/ten_x_v3/flat/3M-february-2018.txt",
    "Velopipe.alreadySortedBam": true
}
```

- `Velopipe.countMatrix`: a file from which filtered barcodes will be extracted
  - dense matrix file (e.g. `*_dense.csv`)
  - barcodes file to construct the sparse matrix (e.g. `*_sparse_counts_barcodes.csv`)
- `Velopipe.bam`: BAM file generated by SEQC
- `Velopipe.bai`: BAM index file
- `Velopipe.gtf`: GTF file
  - Human: `s3://seqc-public/genomes/hg38_long_polya/annotations.gtf`
  - Mouse: `s3://seqc-public/genomes/mm38_long_polya/annotations.gtf`
- `Velopipe.barcodeWhitelist`: a barcode whitelist
  - 10x v2: `s3://seqc-public/barcodes/ten_x_v2/flat/737K-august-2016.txt`
  - 10x v3: `s3://seqc-public/barcodes/ten_x_v3/flat/3M-february-2018.txt`
- `Velopipe.alreadySortedBam`: `true` if the BAM file is already position sorted

### ${sample-name}.labels.json

```json
{
    "pipelineType": "Velopipe",
    "project": "Project 193",
    "sample": "1469_TGFb_LCC-TRL_1_P193",
    "owner": "chunj",
    "destination": "s3://dp-lab-data/Siting/TGFb_LCC_TRL1",
    "transfer": "-",
    "comment": "RNA Velocity"
}
```

- `project`: project ID retrieved from SCRI database
- `sample`: sample name
- `destination`: AWS S3 location where the final output files (e.g. loom) should be saved

## Submitting a Job

```bash
./submit.sh \
    -k ~/secrets-aws.json \
    -i config/your-sample.inputs.json \
    -l config/your-sample.labels.json \
    -o Velopipe.options.aws.json
```
